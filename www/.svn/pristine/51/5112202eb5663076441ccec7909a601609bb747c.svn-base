angular.module('starter.home', [])

.controller('homeCtrl', function($scope, $ionicPlatform, $rootScope, $state, Session, APIManager, ionicToast, $ionicLoading){
	$scope.$on('$ionicView.beforeEnter', function() {		
		$scope.$emit('child', true);
	});
	
	$scope.$on('$stateChangeStart', function() {
		$scope.$emit('child', true);		
	});
	
	Session.clearSession('history');
	Session.saveHistory();
	
	$ionicLoading.show();
	var url = 'search';
	var data = {userid:Session.getSession('user').id, page:'1'};
	if ($rootScope.condition) {
		data.address = $rootScope.condition.location;
		if (data.address == '不限') data.address = 0;
		data.from_age = $rootScope.condition.from_age;
		data.to_age = $rootScope.condition.to_age;
		data.from_stature = $rootScope.condition.from_stature;
		data.to_stature = $rootScope.condition.to_stature;
	}
	
	APIManager.post(url, data).then(function(res) {
		if(res.data != '')
			$scope.users = res.data.users;
		$ionicLoading.hide();
		$scope.more = res.data.is_more;
	});
	
	$scope.likeTa = function(user){
		$ionicLoading.show();
		if(user.islike == false){
			var url = 'ifollow';
			var data = {userid:Session.getSession('user').id, tid:user.id}
			APIManager.get(url, data).then(function(res) {
				user.islike = true;
				user.likes++;
				$ionicLoading.hide();
			});
		}else{
			var url = 'remove_follow';
			var data = {userid:Session.getSession('user').id, tid:user.id}
			APIManager.get(url, data).then(function(res) {
				user.islike = false;
				user.likes--;
				$ionicLoading.hide();
			});
		}
	};
	$scope.goPersonal = function(userid) {
		$state.go('personal_space', {id:userid});
	};
	$scope.nextToSearch = function(){
      $state.go('search');
    }
    $scope.nextToAlert = function(){
        $state.go('alert');
    }

	$scope.loadMore = function() {
		var url = 'get_users';
		$scope.pageNo +=1;
		var data = {userid:Session.getSession('user').id, page:$scope.pageNo}
		APIManager.get(url, data).then(function(res) {
			$scope.users = $scope.users.concat(res.data);
			$scope.$broadcast('scroll.infiniteScrollComplete');
			$scope.more = res.data.is_more;
		});
	};
	
	$ionicPlatform.registerBackButtonAction(function () {			
		Session.exitConfirm($scope);		
	},100);  

});