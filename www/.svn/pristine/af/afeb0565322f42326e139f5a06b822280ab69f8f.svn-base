angular.module('starter.home', [])

.controller('homeCtrl', function($scope, $ionicPlatform, $ionicHistory, $rootScope, $state, Session, APIManager, ionicToast, $ionicLoading){
	
	$ionicHistory.clearHistory();
	Session.clearSession('history');
	Session.saveHistory();		
	
	$scope.$on('$stateChangeSuccess', function(event, toState, toParams, fromState, fromParams){ 
		if (toState.name == 'tab.home') {
			$ionicHistory.clearHistory();
			Session.clearSession('history');
			Session.saveHistory();
			$ionicPlatform.registerBackButtonAction(function (event) {		
				event.preventDefault();
				Session.exitConfirm($scope);				
			},100);
		}
	});
	
	$ionicLoading.show();
	$scope.page = 1;
	var url = 'search';
	var data = {userid:Session.getSession('user').id, page:$scope.page};
	if ($rootScope.condition) {
		data.address = $rootScope.condition.location;
		if (data.address == '不限') data.address = 0;
		data.from_age = $rootScope.condition.from_age;
		data.to_age = $rootScope.condition.to_age;
		data.from_stature = $rootScope.condition.from_stature;
		data.to_stature = $rootScope.condition.to_stature;
	}
	
	APIManager.post(url, data).then(function(res) {
		if(res.data != '')
			$scope.users = res.data.users;
		$ionicLoading.hide();
		$scope.more = res.data.is_more;
	});
	
	$scope.likeTa = function(user){
		$ionicLoading.show();
		if(user.islike == false){
			var url = 'ifollow';
			var data = {userid:Session.getSession('user').id, tid:user.id}
			APIManager.get(url, data).then(function(res) {
				user.islike = true;
				user.likes++;
				$ionicLoading.hide();
			});
		}else{
			var url = 'remove_follow';
			var data = {userid:Session.getSession('user').id, tid:user.id}
			APIManager.get(url, data).then(function(res) {
				user.islike = false;
				user.likes--;
				$ionicLoading.hide();
			});
		}
	};
	$scope.goPersonal = function(userid) {
		$state.go('personal_space', {id:userid});
	};
	$scope.nextToSearch = function(){
      $state.go('search');
    }
    $scope.nextToAlert = function(){
        $state.go('alert');
    }

	$scope.loadMore = function() {
		var url = 'get_users';
		$scope.page++;
		$ionicLoading.show();
		var data = {userid:Session.getSession('user').id, page:$scope.page}
		APIManager.get(url, data).then(function(res) {
			$scope.users = $scope.users.concat(res.data.users);
			$scope.$broadcast('scroll.infiniteScrollComplete');
			$scope.more = res.data.is_more;
			$ionicLoading.hide();
		});
	};
	
	$scope.doRefresh = function() {
		$scope.page = 1;
		var url = 'get_users';
		data = {userid:Session.getSession('user').id, page:$scope.page};
		$ionicLoading.show();
		APIManager.get(url, data).then(function(res) {
			$scope.users = res.data.users;
			$scope.$broadcast('scroll.refreshComplete');
			$scope.more = res.data.is_more;
			$ionicLoading.hide();
		});
	};

});