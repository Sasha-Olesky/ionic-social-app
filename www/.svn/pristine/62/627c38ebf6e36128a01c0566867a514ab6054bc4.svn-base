angular.module('starter.personal', [])

.controller('personalCtrl', function($scope, $ionicHistory, $window, $state, $timeout, $ionicScrollDelegate, $ionicPopup, $ionicLoading, Session, APIManager, ionicToast){
	$scope.$on('$ionicView.beforeEnter', function() {		
		$scope.$emit('child', false);
	});
	
	$scope.$on('$stateChangeStart', function() {		
		$scope.$emit('child', false);		
	});
	$scope.$emit('child', false);
	
	$scope.go_state = function(state) {				
		$state.go(state);
	};
	
	$scope.go_back = function() {		
		Session.goBack();
	};
	
	$scope.go_personal = function(id) {
		$state.go('personal_space',{id:id});
	}
	
	$scope.user = Session.getSession('user');
	$scope.parent_height = $window.innerHeight + 'px';
	$scope.personal_id = $state.params.id;	
	
	var states = ['personal_space', 'video_chat', 'present_shop', 'funny_game', 'play_game'];
	if (states.indexOf($state.current.name) !== -1) {
		Session.saveHistory();
	}
	
	$scope.personal = {};
	
	var url = 'get_personal';
	var data = {userid:$scope.personal_id};
	APIManager.get(url, data).then(function (res){
		$scope.personal = res.data.personal;
		$scope.personal['photo_large'] = "url('" + $scope.personal.photo + "')";
	});	
	
	if ($state.current.name == 'personal_space') {	
		$scope.show_footer = {
			value : false,
			click_send : false
		};
		$scope.cur_post = {
			sel_id : 0,
			sel_index : 0,
			posts : []
		}
		var comment = document.getElementById('say_something');
		$scope.hide_say = function() {
			if ($scope.show_footer.click_send) {
				comment.focus();
				$scope.show_footer.click_send = false;
				return false;
			}
			$scope.show_footer.value = false;
		};
		$scope.send_comment = function() {			
			if (comment.value == '') {
				ionicToast.show('请输入内容', 'middle', false, 1500);
				$scope.show_footer.click_send = true;
				return false;
			}
			var url = 'insert_comment';
			var data = {postid:$scope.cur_post.sel_id, userid:$scope.user.id, comment:comment.value};
			APIManager.post(url, data).then(function (res){						
				$scope.cur_post.posts[$scope.cur_post.sel_index].comments = res.data.comments;
				comment.value = '';
			});
		};
		if ($scope.user.id !== $scope.personal_id) {
			var url = 'set_visitor';
			var data = {userid:$scope.user.id, tid:$scope.personal_id};
			APIManager.get(url, data);
		}
	}		
	
	//*************** Dynamics ***************
	if ($state.current.name == 'personal_space.dynamics') {
		$scope.show_footer.value = false;
		var page = 1;
		var url = 'get_post_of_other';
		var data = {userid:$scope.personal_id, cur_userid:$scope.user.id, page:page};
		$ionicLoading.show();
		APIManager.get(url, data).then(function (res){
			$scope.cur_post.posts = res.data.posts;
			$scope.more = res.data.is_more;			
			$ionicLoading.hide();
		});
		
		$scope.loadMore = function() {
			page++;
			url = 'get_post_of_other';
			data = {userid:$scope.personal_id, cur_userid:$scope.user.id, page:page};
			$ionicLoading.show();
			APIManager.get(url, data).then(function(res) {
				$scope.cur_post.posts = $scope.cur_post.posts.concat(res.data.posts);
				$scope.$broadcast('scroll.infiniteScrollComplete');
				$scope.more = res.data.is_more;
				$ionicLoading.hide();
			});
		};
		
		var comment = document.getElementById('say_something');
		$scope.start_comment = function(p_id, i) {
			$scope.cur_post.sel_id = p_id;
			$scope.cur_post.sel_index = i;
			$scope.show_footer.value = true;
			$timeout(function () {
				comment.focus();
				$scope.show_footer.click_send = false;
			}, 0);
		};
		$scope.like_post = function(p_id, i) {
			if ($scope.cur_post.posts[i].is_like) {
				url = 'dislike_post';
			} else {
				url = 'like_post';
			}
			var data = {postid:p_id, userid:$scope.user.id};
			APIManager.get(url, data).then(function (res){
				$scope.cur_post.posts[i].like_users = res.data.like_users;
				$scope.cur_post.posts[i].is_like = !$scope.cur_post.posts[i].is_like;
			});
		};	
		
	}
	
	//*************** Profile ***************
	if ($state.current.name == 'personal_space.profile') {		
		$scope.profile = {};
		var url = 'get_profile';
		var data = {userid:$scope.personal_id};
		$ionicLoading.show();
		APIManager.get(url, data).then(function (res){
			$scope.profile = res.data.profile;
			$scope.profile.phone = {type: 'password', value : res.data.profile.contact.phone};
			$scope.profile.qq = {type : 'password', value : res.data.profile.contact.qq};
			if ($scope.profile.membership && $scope.user.membership) {
				$scope.profile.phone.type = 'text';
				$scope.profile.qq.type = 'text';
			}
			$ionicLoading.hide();
		});
		
		$scope.upgradeMembership = function() {
			$state.go('update_membership');
		};
	}
	
	$scope.followMe = function(){
		var url = 'ifollow';
		var data = {userid:$scope.user.id, tid:$scope.personal_id};
		APIManager.get(url, data).then(function (res){
			ionicToast.show('关注成功', 'middle', false, 1500);
		});
	};
	
	var myVip, confirm_type;
	$scope.vipConfirm = function(ctype) {
		confirm_type = ctype;
		if (!$scope.user.membership || $scope.user.membership == '0') {
			myVip = $ionicPopup.show({	
				cssClass : 'vip-popup-css',
				templateUrl: 'templates/personal_space/vip_confirm.html',
				scope: $scope
			});
		} else {
			if (confirm_type == 2) {
				var url = 'apply_meet';
				var data = {userid:$scope.user.id, tid:$scope.personal_id};
				APIManager.get(url, data).then(function (res){
					ionicToast.show('申请成功', 'middle', false, 1500);
				});
			} else if (confirm_type == 3) {
				$state.go('video_chat', {id:$scope.personal_id});
			} else if (confirm_type == 4) {
				$state.go('funny_game', {id:$scope.personal_id});
			}
		}		
	};
	$scope.vip_cancel = function() {
		myVip.close();
	};
	$scope.vip_confirm = function() {
		myVip.close();
		$state.go('update_membership');
	};
	
	$scope.go_present_shop = function() {
		$state.go('present_shop', {id:$scope.personal_id});
	}
	
	//*************** gifts ***************
	if ($state.current.name == 'present_shop') {		
		var page = 1;
		var url = 'get_all_gifts';
		var data = {page:page};
		$ionicLoading.show();
		APIManager.get(url, data).then(function (res){
			$scope.gifts = res.data.gifts;
			$scope.more = res.data.is_more;			
			$ionicLoading.hide();
		});
		
		$scope.loadMore = function() {
			page++;
			url = 'get_all_gifts';
			data = {page:page};
			$ionicLoading.show();
			APIManager.get(url, data).then(function(res) {
				$scope.gifts = $scope.gifts.concat(res.data.gifts);
				$scope.$broadcast('scroll.infiniteScrollComplete');
				$scope.more = res.data.is_more;
				$ionicLoading.hide();
			});
		};
		
		$scope.maxScrollHeight = ($window.innerHeight - 110) + 'px';
		$scope.buyConfirm = function() {
			$state.go('buy_coins');
		};		
		var myGiftConfirm;
		$scope.gift = {
			quantity : 1
		};
		$scope.goBuyGift = function(pindex) {
			$scope.gift.quantity = 1;
			$scope.gift.data = $scope.gifts[pindex];
			myGiftConfirm = $ionicPopup.show({	
				cssClass : 'product-popup-css',
				templateUrl: 'templates/personal_space/buy_confirm.html',
				scope: $scope
			});
		};
		$scope.gift_cancel = function() {
			myGiftConfirm.close();
		};
		$scope.gift_confirm = function() {
			var cur_coins = $scope.gift.quantity * $scope.gift.data.gold_coins;
			if (cur_coins > $scope.user.gold_coins) {
				ionicToast.show('我的金币是不够的。', 'middle', false, 1500);
				return false;
			}
			var url = 'send_gift';
			var data = {userid:$scope.user.id, tid:$scope.personal_id, gift_id:$scope.gift.data.id, quantity:$scope.gift.quantity};
			APIManager.get(url, data).then(function (res){
				ionicToast.show('发送成功', 'middle', false, 1500);
				$scope.user.gold_coins = res.data.cur_coins;
				Session.setSession('user', $scope.user);
				myGiftConfirm.close();
			});
		};
		$scope.increaseQuantity = function() {
			$scope.gift.quantity++;
		};
		$scope.decreaseQuantity = function() {
			$scope.gift.quantity--;
			if ($scope.gift.quantity <= 0) $scope.gift.quantity = 1;
		};

	}
	
	
	
	$scope.play_game = function() {
		$state.go('play_game', {id:$scope.personal_id});
	};
	$scope.maxGameHeight = ($window.innerHeight - 180) + 'px';
	$scope.video_chat = function() {
		$state.go('video_chat', {id:$scope.personal_id});
	};
	var myGameCancel, action_id;
	$scope.cancelGame = function(a_id) {
		action_id = a_id;
		myGameCancel = $ionicPopup.show({	
			cssClass : 'game-popup-css',
			templateUrl: 'templates/personal_space/cancel_game.html',
			scope: $scope
		});
	};
	$scope.game_popup_cancel = function() {
		myGameCancel.close();
	};
	$scope.game_cancel = function() {
		myGameCancel.close();
		if (action_id == 0) {
			$scope.go_back();
		} else if (action_id == 1) {
			$state.go('present_shop', {id:$scope.personal_id});
		} else if (action_id == 3) {
			$state.go('video_chat', {id:$scope.personal_id});
		}
	};
	
});